<div class="container">
    <div class="row" id="cards">
        {{#if data}}
        {{#each data}}
        <div class="col-sm-6">
            <div class="card">
                <div class="card-body">
                    <img src="/Files/PEO_M4_Carbine_RAS_M68_CCO.jpg" class="card-img-top" alt="...">
                    <div class="card-body">
                        <h5 id="name{{id}}" class="card-title">{{itemName}}</h5>
                        <textarea id="descr{{id}}" class="card-text form-control"
                            rows="5">{{itemDescription}}</textarea>

                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                        <li class="list-group-item">
                            <h5 id="price{{id}}" class="card-subtitle mb-2 text-muted">Price: ${{itemPrice}}</h5>
                            <h6 id="class{{id}}" class="card-subtitle mb-2 text-muted">Category: {{categoryName}}</h6>
                        </li>
                        <li id="address{{id}}" class="list-group-item">
                            <p>Location</p>{{itemAddress}}<br>{{itemCity}}, {{itemState}} {{itemZip}}
                        </li>
                    </ul>
                    <div class="card-body">
                        <input hidden id="item{{id}}" value="{{id}}" type="text">
                        <a id="edit{{id}}" name="edit{{id}}" href="#" class="card-link btn btn-outline-primary"
                            onclick="editItem({{id}})">Edit</input>
                            <a id="delete{{id}}" href="#" class="card-link btn btn-outline-warning"
                                onclick="deleteItem({{id}})">Delete</a>
                    </div>
                </div>
            </div>
        </div>
        {{/each}}
        {{else}}
        <div class="card text-center">
            <div class="card-header"></div>
            <div class="card-body">
                <h5 class="card-title">You do not have any items to show.</h5>
                <p class="card-text">Post a few items for rent or sale to earn some cash!</p>
                <a href="/addItem" class="btn btn-primary">Get Started</a>
            </div>
            <div class="card-footer text-muted"></div>
        </div>
        {{/if}}
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-6">
            <div id="edits" hidden>
                <form>
                    <div class="card disp-card" style="width: 38rem; padding: 1rem;">
                        <img src="/Files/PEO_M4_Carbine_RAS_M68_CCO.jpg" class="card-img-top" alt="...">
                        <div class="form-group">
                            <label for="edit_name">Title</label>
                            <input id="edit_name" class="form-control" type="text" />
                        </div>
                        <div class="form-group">
                            <label for="edit_descr">Description</label>
                            <textarea class="form-control" id="edit_descr" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit_price">Price</label>
                            <input id="edit_price" class="form-control" type="text" />
                        </div>
                        <div class="form-group">
                            <label for="inputCat">Category</label>
                            <select id="inputCat" class="form-control">
                                <option selected>Choose...</option>
                                <option>...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="inputAddress">Street</label>
                            <input type="text" class="form-control" id="inputAddress">
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="inputCity">City</label>
                                <input type="text" class="form-control" id="inputCity">
                            </div>
                            <div class="form-group col-md-4">
                                <label for="inputState">State</label>
                                <select id="inputState" class="form-control">
                                    <option value="">
                                        Please Select...
                                    </option>
                                    <option value="AK">
                                        Alaska
                                    </option>
                                    <option value="AL">
                                        Alabama
                                    </option>
                                    <option value="AR">
                                        Arkansas
                                    </option>
                                    <option value="AZ">
                                        Arizona
                                    </option>
                                    <option value="CA">
                                        California
                                    </option>
                                    <option value="CO">
                                        Colorado
                                    </option>
                                    <option value="CT">
                                        Connecticut
                                    </option>
                                    <option value="DC">
                                        District of Columbia
                                    </option>
                                    <option value="DE">
                                        Delaware
                                    </option>
                                    <option value="FL">
                                        Florida
                                    </option>
                                    <option value="GA">
                                        Georgia
                                    </option>
                                    <option value="HI">
                                        Hawaii
                                    </option>
                                    <option value="IA">
                                        Iowa
                                    </option>
                                    <option value="ID">
                                        Idaho
                                    </option>
                                    <option value="IL">
                                        Illinois
                                    </option>
                                    <option value="IN">
                                        Indiana
                                    </option>
                                    <option value="KS">
                                        Kansas
                                    </option>
                                    <option value="KY">
                                        Kentucky
                                    </option>
                                    <option value="LA">
                                        Louisiana
                                    </option>
                                    <option value="MA">
                                        Massachusetts
                                    </option>
                                    <option value="MD">
                                        Maryland
                                    </option>
                                    <option value="ME">
                                        Maine
                                    </option>
                                    <option value="MI">
                                        Michigan
                                    </option>
                                    <option value="MN">
                                        Minnesota
                                    </option>
                                    <option value="MO">
                                        Missouri
                                    </option>
                                    <option value="MS">
                                        Mississippi
                                    </option>
                                    <option value="MT">
                                        Montana
                                    </option>
                                    <option value="NC">
                                        North Carolina
                                    </option>
                                    <option value="ND">
                                        North Dakota
                                    </option>
                                    <option value="NE">
                                        Nebraska
                                    </option>
                                    <option value="NH">
                                        New Hampshire
                                    </option>
                                    <option value="NJ">
                                        New Jersey
                                    </option>
                                    <option value="NM">
                                        New Mexico
                                    </option>
                                    <option value="NV">
                                        Nevada
                                    </option>
                                    <option value="NY">
                                        New York
                                    </option>
                                    <option value="OH">
                                        Ohio
                                    </option>
                                    <option value="OK">
                                        Oklahoma
                                    </option>
                                    <option value="OR">
                                        Oregon
                                    </option>
                                    <option value="PA">
                                        Pennsylvania
                                    </option>
                                    <option value="PR">
                                        Puerto Rico
                                    </option>
                                    <option value="RI">
                                        Rhode Island
                                    </option>
                                    <option value="SC">
                                        South Carolina
                                    </option>
                                    <option value="SD">
                                        South Dakota
                                    </option>
                                    <option value="TN">
                                        Tennessee
                                    </option>
                                    <option value="TX">
                                        Texas
                                    </option>
                                    <option value="UT">
                                        Utah
                                    </option>
                                    <option value="VA">
                                        Virginia
                                    </option>
                                    <option value="VT">
                                        Vermont
                                    </option>
                                    <option value="WA">
                                        Washington
                                    </option>
                                    <option value="WI">
                                        Wisconsin
                                    </option>
                                    <option value="WV">
                                        West Virginia
                                    </option>
                                    <option value="WY">
                                        Wyoming
                                    </option>
                                </select>
                            </div>
                            <div class="form-group col-md-2">
                                <label for="inputZip">Zip</label>
                                <input type="text" class="form-control" id="inputZip">
                            </div>
                        </div>
                        <div class="card-body">
                            <input hidden id="edit_item_Id" type="text">
                            <a id="save_edit" href="#" class="card-link btn btn-outline-primary"
                                onclick="saveEdit()">Save</a>
                            <a id="cancel_it" href="#" class="card-link btn btn-outline-warning"
                                onclick="cancelEdit()">Cancel</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>



<script>
    document.addEventListener("DOMContentLoaded", () => {

    });

    function saveEdit() {
        console.log("Saving edit......");
        let itemId = document.getElementById("edit_item_Id").value;
        let title = document.getElementById("edit_name").value;
        let descr = document.getElementById("edit_descr").value;
        let price = document.getElementById("edit_price").value;
        let category = document.getElementById("inputCat").value;
        let street = document.getElementById("inputAddress").value;
        let city = document.getElementById("inputCity").value;
        let state = document.getElementById("inputState").value;
        let zip = document.getElementById("inputZip").value;

        let item = {
            itemID: itemId,
            catID: category,
            itemName: title,
            itemDescription: descr,
            itemPrice: price,
            itemAddress: street,
            itemCity: city,
            itemState: state,
            itemZip: zip,
        }

        var req = new XMLHttpRequest();
        req.open('POST', '/editItem/save', true)
        req.setRequestHeader('Content-Type', 'application/json');
        req.addEventListener('load', function () {
            //Process response
            if (req.status >= 200 && req.status < 400) {
                var resp = req.responseText;
                console.log(resp);
                location.reload();
            } else {
                console.log("Error in network request: " + req.statusText);
            }
        });
        req.send(JSON.stringify(item));
    }

    function cancelEdit() {
        document.getElementById("edits").hidden = true;
        document.getElementById("cards").hidden = false;
        document.getElementById("edit_name").value = "";
        document.getElementById("edit_descr").value = "";
        document.getElementById("edit_price").value = "";
        document.getElementById("inputCat").value = "";
        document.getElementById("inputAddress").value = "";
        document.getElementById("inputCity").value = "";
        document.getElementById("inputState").value = "";
        document.getElementById("inputZip").value = "";
    }

    function populateCategories(data) {
        let category = document.getElementById("inputCat");
        var req = new XMLHttpRequest();
        req.open('GET', '/editItem/cats', true);
        req.addEventListener('load', function () {
            //Process response
            if (req.status >= 200 && req.status < 400) {
                var resp = JSON.parse(req.responseText);
                // Add a dropdown option for every category found in the data base
                for (var i = 0; i < resp.length; i++) {
                    var option = document.createElement("option");
                    option.text = resp[i].categoryName;
                    option.value = resp[i].categoryId;
                    // Select current category
                    if (option.value == data.categoryId) {
                        option.selected = true;
                    }
                    category.add(option);
                }
                console.log(resp);
            } else {
                console.log("Error in network request: " + req.statusText);
            }
        });
        req.send(null);
    }

    function populateEditForm(data) {
        let itemId = document.getElementById("edit_item_Id");
        let title = document.getElementById("edit_name");
        let descr = document.getElementById("edit_descr");
        let price = document.getElementById("edit_price");
        let category = document.getElementById("inputCat");
        let street = document.getElementById("inputAddress");
        let city = document.getElementById("inputCity");
        let state = document.getElementById("inputState");
        let zip = document.getElementById("inputZip");

        title.focus();
        itemId.value = data.id;
        title.value = data.itemName;
        descr.value = data.itemDescription;
        price.value = data.itemPrice;
        street.value = data.itemAddress;
        city.value = data.itemCity;
        zip.value = data.itemZip;

        for (var i = 0; i < state.options.length; i++) {
            if (state.options[i].value == data.itemState) {
                state.options[i].selected = true;
            }
        }
        populateCategories(data);
    }

    function editItem(id) {
        document.getElementById("edits").hidden = false;
        document.getElementById("cards").hidden = true;

        var req = new XMLHttpRequest();
        req.open('POST', '/editItem/id', true)
        req.setRequestHeader('Content-Type', 'application/json');
        req.addEventListener('load', function () {
            //Process response
            if (req.status >= 200 && req.status < 400) {
                var resp = JSON.parse(req.responseText);
                populateEditForm(resp);
            } else {
                console.log("Error in network request: " + req.statusText);
            }
        });
        payload = { id: id }
        req.send(JSON.stringify(payload));
    }

    function deleteItem(id) {

        var r = confirm("This will permanently remove the item.\nThis change may not be undone!");
        if (r == true) {
            var req = new XMLHttpRequest();
            req.open('DELETE', '/editItem', true)
            req.setRequestHeader('Content-Type', 'application/json');
            req.addEventListener('load', function () {
                //Process response
                if (req.status >= 200 && req.status < 400) {
                    var resp = req.responseText;
                    location.reload();
                } else {
                    console.log("Error in network request: " + req.statusText);
                }
            });
            payload = { id: id }
            req.send(JSON.stringify(payload));
        }
    }

</script>